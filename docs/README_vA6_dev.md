# README_vA6_dev — 思想・設計・運用・試行の統合点
（2025年11月版｜試行統合版）

---

## 第0章：方針（vA6 引継ぎ用まとめ）

本書は、vA4+〜vA5.1に至る思想・設計・運用を統合し、  
vA6_dev（試行統合版）→vA6_main（完成版） の体系を確立するための引継ぎ資料である。  
後継者はこの文書を起点に、vA6_mainを参照すれば完全再現が可能。  
AI・研究者はvA6_devを通じて思想と試行の変遷を追跡できる。

---

### 🧩 システム構造の世代整理
| 世代 | 名称 | 位置づけ | 主な内容 |
|------|------|------------|-----------|
| vA4+ | 運用版 | 現場運用ドキュメント | Render／Neon／GitHub監視、RTO/RPO、実装手順 |
| vA5 | 設計統合版 | 技術構造＋思想の橋渡し | API構造、鍵運用、バックアップ思想 |
| vA5.1 | 思想確定版 | 「真実のソース」宣言 | 哲学・思想・運用凍結方針 |
| vA6_dev | 試行統合版 | 思想・設計・運用＋試行の集約 | A′案・一発実装記録・統合理解 |
| vA6_main | 完成運用版 | 後継者用・再現性最優先 | 「5クリック＋数回コピペ」で復旧可 |

---

### 🧱 vA6 体系の構造
/docs  
├── README_vA6_dev.md ← 試行・思想・検証を記録  
├── README_vA6_main.md ← 完成版（後継者用）  
├── archive/ ← 凍結資料群  
│ ├── README_vA4+.md  
│ ├── README_vA5.md  
│ └── README_vA5.1.md  
├── init.sql ← Neon初期化用SQL  
├── openapi.yaml ← ChatGPT Actions登録用仕様書  
└── structure_Aprime.md ← A′案構成図

---

### 🧭 vA6_dev の目的と位置づけ
vA6_dev = 思想・設計・試行の統合点。

目的：

- vA4+〜vA5.1の全知識を統合し、試行と思想を記録する。  
- 一発実装（A′案）を検証し、その過程と結果を残す。  
- 成功要素のみをvA6_mainに抽出して最終形とする。

---

### 🔁 作業フロー（再現可能手順）

1. vA6_devを作成 → vA4+／vA5／vA5.1／試行ログを章別に再構成。  
2. 一発実装を実施 → A′案（5クリック＋数回コピペ）構成を再現。  
3. vA6_devへ記録追記 → 実装過程・判断理由・修正経緯を第5章に残す。  
4. vA6_mainを作成 → 成功形を抜粋し後継者用に整備。  
5. 旧版3文書を凍結保管 → /archive/ に移動し「統合済み」注記を付ける。

---

### 🧭 凍結資料の扱い方
削除せず /archive/ に格納。冒頭に以下を追記：

> 本書はvA6_dev統合後のアーカイブ資料です。  
> 現行の運用はREADME_vA6_mainを参照してください。

---

### 📚 引継ぎ時の参照順序
1. DEATH.md → 起動ガイド兼導線。「まずREADME_vA6_mainを読む」と記載。  
2. README_vA6_main → 実際の操作・復旧手順。  
3. README_vA6_dev → 背景・思想・開発過程の理解用。  
4. archive/ → 歴史・思想研究・AI学習用（参照のみ）。

---

### ✅ 最終整理
削除方針：旧版は削除せず凍結。  
統合方式：思想・構造・運用を3章構成でvA6_devに吸収。  
運用目標：5クリック＋数回コピペで復旧可能なA′案を完成。  
思想目標：後継者は理解でなく「利用を通じて学ぶ」。  
あなたの役割：思想と構造を整理し、残す側に回る。

---

## 第1章：思想と起源

この章では、「なぜこのシステムを作るのか」「どんな哲学に基づいているか」を示す。

---

#### 🌱 出発点：「真実のソース」という考え方

vA5.1 では、システムを単なるツールではなく「真実のソース」と定義した。  
人が手を加えずとも、自らの状態を正確に示し続ける記録。  
それは「事故後もこの1枚から復旧できる」ことを目指した思想だった。

---

#### 🪞 人が触れても壊れない窓

この思想は「人が触れても壊れない窓」として具体化された。  
操作やミスで壊れるのではなく、人が理解するほど安定する。  
最小の構造で、最大の再現性をもつ“窓”を残すことが目的である。

---

#### ⚙️ 技術と思想の橋渡し

vA5 系では技術仕様と思想が別々に存在していたが、  
vA6 では両者を統合し、「思想が設計を導く」構造に変えた。  
設計や運用の判断は、常に「人が触れても壊れないか」を基準に行う。

---

#### 🧭 vA6_dev の位置づけ

この章を含む vA6_dev 全体は、思想・設計・運用の統合試行である。  
完成版（vA6_main）は後継者のためのマニュアルだが、  
vA6_dev は思想と検証の記録であり、「なぜそうなったか」を残す役割をもつ。

---

## 第2章：設計と構造

この章では、vA6 システムの「中身の仕組み」と「設計思想」を説明する。  
コードではなく、構成と役割を理解するための文章。

---

#### 🧱 基本構造（Render × Neon × GitHub）

vA6 は、3つの無料クラウドを組み合わせて動作する。

| 要素 | 役割 | 無料である理由 |
|------|------|----------------|
| **Render** | アプリ本体を動かす場所。APIサーバ。 | Free Planで常時稼働可（監視でスリープ防止） |
| **Neon** | データベース（PostgreSQL）。 | Free TierでDBを保存・復元可能。PITR対応。 |
| **GitHub** | ソースコード・バックアップ・自動実行。 | Public RepoとActions無料枠を活用。 |

これらは全て「クラウドオンリー」で完結しており、  
ローカルPCが壊れても復旧できる構成になっている。

---

#### 🔑 三鍵分離（セキュリティ思想）

vA6 では管理権限を3つの鍵に分けて運用する。  
これにより、誤操作や漏えいのリスクを最小化している。

| 鍵の種類 | 主な用途 | 保持者 |
|-----------|-----------|---------|
| **READ_KEY** | 公開閲覧用（/healthなど） | 一般閲覧者 |
| **EXPORT_KEY** | データエクスポート用（/export.csv） | 自動バックアップ機構 |
| **ADMIN_KEY** | 登録・削除など管理操作 | 管理者（あなた） |

この分離は「安全に共有できる最低限の構造」を目指した設計思想である。

---

#### 💾 バックアップと監視の統合設計

vA6 では「保存」と「監視」を別々にせず、一体として設計した。  
GitHub Actions が定期的に Render の `/export.csv` を取得し、  
そのままリポジトリ内の `backups/` に保存する。

また、UptimeRobot など外部監視が Render の `/health` を監視し、  
APIが落ちた際には自動的に再起動が促される構成となっている。

→ **結果：** 「自動バックアップ＋自動監視」で、  
無料枠ながら“自己修復型”の運用が可能になった。

---

#### 🧩 CORSとUIの位置づけ（Minimal Web UI）

UI（ブラウザ画面）は GitHub Pages で配信し、  
Render 側の API と連携して動作する。

UI は最小限（HTML + JSのみ）で、  
思想的には「人が触れても壊れない窓」の具現化。

CORS 設定により、Render と GitHub Pages の通信を安全に限定。  
UI 側からの書き込みは ADMIN_KEY による認証で制御される。

---

#### 🧠 設計の指針

すべての設計判断は、次の3原則に基づく。

1. **無料で維持できること**（永続性）  
2. **壊れても復旧できること**（再現性）  
3. **人が触れても壊れないこと**（寛容性）

この3つを満たす範囲でのみ、機能を採用・統合する。

---

## 第3章：運用と実証

この章では、vA6 システムを実際に動かした記録と、その中で確立された運用原則をまとめる。  
出典は主に vA4+（Render実運用・RTO/RPO訓練・GitHub監視体制）である。

---

#### 🚀 運用目的

目的は「無料枠で常時動作する自己修復型システム」を確立すること。  
RTO（復旧時間）30分、RPO（データ損失許容）24時間以内を目標にした。

---

#### 🔄 運用構成（Render / Neon / GitHub）

| 層 | 役割 | 自動化の仕組み |
|----|------|----------------|
| **Render** | アプリ運用・自動再起動 | UptimeRobotが15分間隔で /health を監視。落ちたら再起動。 |
| **Neon** | データ保持・復旧 | 月次PITR確認＋CSVエクスポートで二重復旧経路を確保。 |
| **GitHub Actions** | 自動バックアップ | 毎日 /export.csv を取得し、`backups/` に保存。実行ログも残す。 |

結果、手動操作がなくても稼働・保存・監視が循環する構成になった。

---

#### 🕒 定期訓練（RTO/RPOドリル）

RTO/RPO を維持するため、週1回の「復旧訓練」を行った。  
- **RTO訓練**：Renderを強制停止→再起動までの時間を測定。  
- **RPO訓練**：Neonから任意のバックアップを復元し、CSVとの差異を確認。

この訓練により、常に「30分以内復旧・1日以内復元」が保証された。

---

#### 📊 監視設計（UptimeRobot × GitHub）

- **UptimeRobot**：Render の `/health` を外部から監視。  
- **GitHub Actions**：内部から `/export.csv` を監視。  
- 2つの異なる監視経路により、Render のスリープ・停止を即検知できる。

→ 外部と内部の2系統構成により、「止まらない・気づける・戻せる」を実現。

---

#### 🧰 手動介入ポイント（人の役割）

完全自動化は目的ではない。  
人が介入するべき場面は、**判断が必要なときだけ**に限定された。

| 対象 | 判断内容 | 頻度 |
|------|-----------|------|
| GitHub Actions | エラー時の再実行可否 | 必要時のみ |
| Neon | 月次バックアップ・PITR確認 | 月1回 |
| README更新 | 方針転換・成果記録 | 主要更新時のみ |

これにより「人が触れても壊れない」運用が現実化した。

---

#### ✅ 実証結果と教訓

1. 無料枠でも常時稼働が維持できることを確認。  
2. cron-job.org のタイムアウトを避けるため、監視経路を二重化。  
3. GitHub Actions の遅延（最大20分）を検証し、許容範囲内と判断。  
4. Render／Neon／GitHub の3層を分離した構造が、障害時の切り分けを容易にした。  
5. 「自動＋監視＋最小介入」が最も壊れにくい構成であると確認。

---

#### 🌱 運用思想の定着

運用設計の最終目的は「仕組みが動いている間に、人が学べる時間を確保する」こと。  
すなわち **自動化は“手放すため”でなく、“考える余白を作るため”の道具** である。

---

## 第4章：A案と一発実装

この章では、vA6 開発の中で実際に行われた「一発実装（A案）」を記録する。  
目的は、構想から実働に移る瞬間の意思決定・検証・結果を残すことである。

---

#### ⚙️ 一発実装の目的

A案の実装は、思想・設計・運用のすべてを1回で統合する試みだった。  
部分実装ではなく、Render・Neon・GitHub を同時稼働させ、  
「動くものを1回で完成させる」ことを目標とした。

---

#### 🧩 実装構成（統合対象）

| 領域 | 内容 | 成果 |
|------|------|------|
| **Render** | Node.js サーバ（/health, /notes, /export.csv）を常時稼働化 | UptimeRobot監視でスリープ防止を達成 |
| **GitHub Actions** | 自動バックアップと動作検証を連携 | 日次CSV保存・/healthチェック・Issue連携を統合 |
| **Neon** | DB構造の安定化とCSV復旧確認 | deleted_at／PITR動作検証を通過 |

---

#### 🚀 実装手順（時系列）

1. Render 環境を再構築し、/health 応答を確認（503→200へ）。  
2. GitHub Actions で /export.csv の自動バックアップを開始。  
3. Neon のデータを初期化し、同一スキーマで復元可能であることを確認。  
4. UptimeRobot による常時稼働監視を有効化。  
5. `/notes` CRUD の再検証を実施し、データの完全往復を確認。  

→ この5工程をもって「思想・設計・運用・実証」が1点に収束した。

---

#### 🧱 実装後の状態

- Render：スリープせず24時間応答維持。  
- Neon：PITR確認済み・スナップショット正常。  
- GitHub：Actionsが自動バックアップ・正常ログ出力。  
- UptimeRobot：連続稼働監視中。  

結果、vA6 は **「無料で壊れずに動き続ける最小構造」** を実証した。

---

#### 🧭 教訓と判断基準

1. 「動くもの」を作る瞬間が、思想の最終検証である。  
2. 理論よりも実装の整合を優先する。  
3. 無料で動く範囲こそが「本当に必要な構造」を浮き彫りにする。  
4. エラーは想定内、記録があれば失敗ではない。  
5. すべての構築は「次に学ぶための材料」である。

---

#### 💡 A案の結論

A案は成功した。  
それは「完全ではないが、修復可能な構造」として動作したからである。  
この成果をもって、vA6_main へ移行する判断が下された。

---

## 第5章：結果と確定方針

この章では、vA6_dev の成果を整理し、vA6_main への継承方針を明示する。

---

#### 🧭 確定事項（技術・運用）

1. **Render**：無料常時稼働構成を確定。UptimeRobot監視を正式採用。  
2. **Neon**：PITR／スナップショット運用を正式採用。  
3. **GitHub Actions**：/export.csv 自動バックアップを標準化。  
4. **CORS構成**：UI_ORIGINによる安全通信方式を正式仕様化。  
5. **鍵運用**：三鍵分離構造（READ／EXPORT／ADMIN）を標準採用。  

→ この5要素を「vA6_main」の基本構成として凍結する。

---

#### 📦 成果物一覧（移行対象）

| 種別 | 内容 | 位置 |
|------|------|------|
| **README_vA6_dev.md** | 思想・設計・運用・実装の統合記録 | `/docs/` |
| **README_vA6_main.md** | 完成版・運用指針 | `/docs/` |
| **/export.csv** | 自動出力・日次バックアップ | `/backups/` |
| **/notes API** | CRUD操作の中核 | `/api/notes` |
| **openapi.yaml** | ChatGPT Actions 登録仕様書 | `/docs/` |

---

#### 🔄 移行手順（vA6_dev → vA6_main）

1. README_vA6_main.md を新規作成し、vA6_dev の確定要素のみを移植する。  
2. 試験的要素（検証・実験・仮説）は移行しない。  
3. archive/ に旧版（vA4+〜vA5.1）を保管。  
4. vA6_main は「保守・説明・引継ぎ用ドキュメント」として運用。  
5. vA6_dev は思想検証と開発記録として保存（削除しない）。  

---

#### 🔒 凍結ポリシー

- vA6_dev は「記録・思想・検証の証跡」として保全。  
- vA6_main は「実運用の安定版」として凍結。  
- 双方は相互参照可能な状態を維持し、混同を防ぐ。  
- 以後の変更は「vA7以降」として分岐管理する。  

---

#### 🧾 精密作業ログ（原記録版）

| 日付 | 作業時間 | 内容 |
|------|-----------|------|
| 9月7日 | 4:00 | Neon、GitHub、Render、アカウント登録 ok.true確認 |
| 9月11日 | 3:00 | OpenAPI設定、GET/POST成功 |
| 9月14日 | 2:45 | API安定化、認証削除・タグ・バックアップ定義付け（GitHub履歴確認済） |
| 9月15日 | 13:30 | PATCH/DELETE成功、エラーハンドリング、認証（Bearer API_KEY）、DB更新履歴追跡 |
| 9月25日 | 2:20 | OpenAI API課金検討（意味検索準備、無料機能優先） |
| 9月27日 | 3:30 | タグ付け、タグバリデーション |
| 9月29日 | 1:01 | タグ正規化、基本検索機能、インデックス最適化、検索UI改善 |
| 10月1日 | 5:16 | ページネーション、CSVエクスポート、タスクスケジューラ設定 |
| 10月2日 | 1:03 | タスクスケジューラ調整、機能追加構想 |
| 10月4日 | 0:42 | バリデーション統一、filtersAPI実装 |
| 10月5日 | 4:57 | notes-selftest実装、CSV出力、UTF-8短縮エイリアス、similarity+rank_min実装 |
| 10月7日 | 0:36 | ChatGPTActions認証エラー修正 |
| 10月9日 | 2:29 | Pg_trgm全文検索導入、検索クエリ動作確認 |
| 10月9日 | 0:30 | OpenAPI更新忘れ修正、API_KEY反映 |
| 10月11日 | 1:59 | 全文検索強化（閾値、並び順、自然言語説明） |
| 10月13日 | 0:14 | Pg_trgm性能検証、API_KEY直書き修正、自動エクスポート安全化 |
| 10月14日 | 3:35 | 紛失した作業記録の再構成開始 |
| 10月15日 | 4:05 | README vA4+ 作成 |
| 10月16日 | 2:37 | README vA5／vA5.1 作成 |
| 10月22日 | 2:01 | GitHub Actions日次バックアップ＆ヘルス自動チェック、クラウドオンリー方針決定 |
| 10月23日 | 1:28 | Minimal WebUI CORS整合 |
| 10月26日 | 1:32 | Minimal WebUI 三鍵対応実装、鍵運用方針検討 |
| 10月29日 | 0:57 | 三鍵全環境へ統一適用 |
| 10月30日 | 1:06 | Google Drive自動バックアップ実装 |
| 11月1日 | 2:42 | ソフトデリート実装、PITR確認と復元テスト |
| 11月2日 | 2:36 | cron-jobヘルス自動チェック実装、GitHub Actions監視停止、UI削除／復元ボタン実装 |
| 11月3日 | 4:55 | OpenAPI Admin_KEY適用、全機能フルチェック |
| 11月5日 | 1:10 | UptimeRobotヘルス自動チェック実装、cron-job監視停止 |

---

#### 🧠 思想的結論

vA6_dev の存在意義は、「不完全なまま動くこと」を証明した点にある。  
完全を求めず、修復可能であることを肯定する思想は、  
AI時代の人間的設計思想として、次世代への橋渡しとなる。  

> **vA6_main = 実装の完成形**  
> **vA6_dev = 思想の記録形**

この二層構造こそが、「人が触れても壊れないシステム」の真実の姿である。

---

## 付録：旧版参照リンク

- [README_vA4+.md](../archive/README_vA4+.md)
- [README_vA5.md](../archive/README_vA5.md)
- [README_vA5.1.md](../archive/README_vA5.1.md)

---

### 【補足】初心者用クイックガイド（README_vA6_quick.md）について

本書（vA6_dev）は、思想・設計・検証を統合した試行記録であり、  
後継者・非技術者向けの操作手順書として、別途  
`README_vA6_quick.md` を作成する。

- **目的**：最小手数（5クリック＋数回コピペ）で再構築できること。  
- **位置**：`/docs/README_vA6_quick.md`（Render非同期）  
- **対象**：技術知識を持たない後継者・管理者・家族。  
- **構成**：起動／停止／バックアップ確認／復旧 の4セクションを中心に構成。  
- **更新方針**：思想や技術構造に変更があっても、本書ではなく Quick 版でのみ更新する。

> vA6_dev → vA6_main → vA6_quick の順に抽象度を下げ、  
> 「理解」よりも「動かせる」ことを重視する構成とする。
